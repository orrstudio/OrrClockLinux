# Документация по системе настроек OrrClockLinux

## Оглавление
1. [Общая архитектура](#1-общая-архитектура)
2. [Хранение данных](#2-хранение-данных)  
   2.1. [База данных](#21-база-данных)  
   2.2. [Инициализация БД](#22-инициализация-бд)  
   2.3. [Методы работы с настройками](#23-методы-работы-с-настройками)
3. [Пользовательский интерфейс](#3-пользовательский-интерфейс)  
   3.1. [Окно настроек](#31-окно-настроек)  
   3.2. [Доступные цвета](#32-доступные-цвета)
4. [Работа с цветами](#4-работа-с-цветами)  
   4.1. [Представление цветов](#41-представление-цветов)  
   4.2. [Конвертация](#42-конвертация)
5. [Жизненный цикл настроек](#5-жизненный-цикл-настроек)
6. [Особенности реализации](#6-особенности-реализации)
7. [Пример использования](#7-пример-использования)

## 1. Общая архитектура

Система настроек в приложении OrrClockLinux реализована с использованием паттерна "Менеджер" и состоит из следующих компонентов:

- **SettingsManager** - центральный класс для управления настройками
- **SettingsWindow** - модальное окно с интерфейсом настроек
- **ColorButton** - пользовательский виджет для выбора цвета
- **SettingsDatabase** - класс для работы с базой данных SQLite

## 2. Хранение данных

### 2.1. База данных
- Используется SQLite база данных `data/settings.db`
- Две основные таблицы:
  - `settings` - хранит настройки в формате ключ-значение
  - `window_settings` - хранит параметры окна (размер, положение)

### 2.2. Инициализация БД
При первом запуске создаются необходимые таблицы и устанавливаются значения по умолчанию:
- Цвет по умолчанию: 'lime'
- Размер окна по умолчанию: 715x1000 пикселей

### 2.3. Методы работы с настройками
- `get_setting(key)` - получение значения настройки по ключу
- `save_setting(key, value)` - сохранение настройки
- `save_window_settings(width, height, x, y)` - сохранение параметров окна
- `get_window_settings()` - получение параметров окна
- `apply_window_settings(window)` - применение сохраненных параметров к окну

## 3. Пользовательский интерфейс

### 3.1. Окно настроек
- Реализовано как модальное окно (наследник `ModalView` из Kivy)
- Содержит сетку из 9 цветов для выбора
- Кнопки "Сохранить" и "Отмена"
- Адаптивный интерфейс с поддержкой прокрутки

### 3.2. Доступные цвета
```python
colors = {
    'lime': (0, 1, 0, 1),
    'aqua': (0, 1, 1, 1),
    'blue': (0, 0, 1, 1),
    'red': (1, 0, 0, 1),
    'yellow': (1, 1, 0, 1),
    'white': (1, 1, 1, 1)
}
```

## 4. Работа с цветами

### 4.1. Представление цветов
- Внутреннее представление: кортеж (r, g, b, a)
- В базе данных: строковое имя цвета (например, 'lime', 'blue')

### 4.2. Конвертация
- `get_color_tuple(color_name)` - преобразует имя цвета в кортеж RGBA
- `get_color_name(color_tuple)` - находит имя цвета по кортежу

## 5. Жизненный цикл настроек

1. **Инициализация**:
   - Создается экземпляр `SettingsManager` с передачей виджета часов и главного окна
   - Загружаются сохраненные настройки из БД
   - Применяются к интерфейсу

2. **Изменение настроек**:
   - Пользователь открывает окно настроек
   - Выбирает новый цвет
   - Подтверждает выбор кнопкой "Сохранить"
   - Настройки сохраняются в БД и применяются к интерфейсу

3. **Отмена изменений**:
   - При нажатии "Отмена" изменения не сохраняются
   - Восстанавливается предыдущее состояние

## 6. Особенности реализации

1. **Обработка ошибок**:
   - Все операции с базой данных обернуты в try-except
   - При ошибках загрузки настроек используются значения по умолчанию

2. **Производительность**:
   - Минимальное количество обращений к БД
   - Кэширование часто используемых значений

3. **Масштабируемость**:
   - Легко добавить новые настройки через таблицу `settings`
   - Гибкая система обратных вызовов для применения настроек

## 7. Пример использования

```python
# Создание менеджера настроек
settings_manager = SettingsManager(clock_label=clock_widget, main_window=main_window)

# Открытие окна настроек
settings_manager.open_settings_window()

# Применение настроек
settings_manager.apply_settings((1, 0, 0, 1))  # Красный цвет
```

Эта архитектура обеспечивает гибкость, простоту поддержки и расширяемость системы настроек приложения.
